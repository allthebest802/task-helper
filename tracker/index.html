<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meltdown Trigger Tracker (Local Only)</title>
  <style>
    
:root{
      --bg:#f4f8ff;
      --panel:rgba(255,255,255,.85);
      --panel2:rgba(255,255,255,.95);
      --text:#1b2a4a;
      --muted:#5f6f95;
      --line:rgba(120,170,255,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius:18px;
      --radius2:14px;
      --focus: 0 0 0 3px rgba(120,170,255,.45);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(800px 500px at 10% 10%, rgba(120,170,255,.25), transparent 60%),
        radial-gradient(700px 500px at 90% 20%, rgba(120,220,180,.25), transparent 60%),
        radial-gradient(600px 500px at 50% 100%, rgba(255,210,120,.18), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.45;
    }
header{
      max-width: 1180px;
      margin: 22px auto 0;
      padding: 0 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    h1{ margin:0; font-size: clamp(22px, 2.2vw, 30px); }
    .sub{ margin:6px 0 0; color:var(--muted); max-width: 86ch; font-size:14px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      margin-top:8px;
    }
    .wrap{
      max-width: 1180px;
      margin: 16px auto 60px;
      padding: 0 16px;
      display:grid;
      grid-template-columns: 440px 1fr;
      gap: 16px;
    }
    @media (max-width: 1020px){ .wrap{ grid-template-columns: 1fr; } }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{ padding: 14px 14px 0; }
    .panelBody{ padding: 14px; }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    button{
      font-family:inherit;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-size: 14px;
      line-height:1;
    }
    button:hover{ background: rgba(255,255,255,.07); }
    button:active{ transform: translateY(1px); }
    button:focus-visible{ outline:none; box-shadow: var(--focus); }
    
.primary{
      background: linear-gradient(180deg, #9fc2ff, #78aaff);
      border-color:#78aaff;
      color:#0b1a3a;
    }

.danger{
      background: linear-gradient(180deg, #ffb3c1, #ff8fa3);
      border-color:#ff8fa3;
      color:#3a0b14;
    }
.ok{
      background: linear-gradient(180deg, #9fe3c8, #6fd6b2);
      border-color:#6fd6b2;
      color:#0b2a1d;
    }
.ghost{ background: transparent; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid .full{ grid-column: 1 / -1; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="date"], input[type="time"], textarea, select{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
    }
    textarea{ min-height: 72px; resize: vertical; }
    input:focus, textarea:focus, select:focus{ box-shadow: var(--focus); border-color: rgba(120,170,255,.35); }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      color: var(--muted);
    }
    .chip[aria-pressed="true"]{
      color: var(--text);
      border-color: rgba(120,170,255,.30);
      background: rgba(120,170,255,.14);
    }

    .inlineCheck{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      color: var(--muted);
      user-select:none;
    }
    .inlineCheck input{ width:18px; height:18px; }

    .status{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .summary{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .card{
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.04);
      padding: 12px;
    }
    .card h3{ margin:0 0 8px; font-size: 14px; }
    .small{ font-size: 12px; color: var(--muted); }
    .big{
      font-size: 26px;
      font-weight: 800;
      letter-spacing:.3px;
    }
    .list{
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: rgba(60,220,170,.38);
    }

    .tableWrap{
      padding: 0 14px 14px;
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    th, td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      vertical-align: top;
      font-size: 13px;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 700;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{ border-bottom:none; }
    .actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      margin-right:6px;
      margin-top:6px;
      white-space:nowrap;
    }

    .expRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .expList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .expItem{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .expTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .expName{ font-weight:800; }
    .expMeta{ color:var(--muted); font-size:12px; }
    .expBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .expStats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }

    @media print{
      header .row, .noPrint{ display:none !important; }
      body{ background:#fff !important; color:#111 !important; }
      .panel{ border:none !important; box-shadow:none !important; background:#fff !important; }
      .wrap{ grid-template-columns: 1fr !important; max-width:none !important; margin:0 !important; padding:0 !important; }
      table, th, td{ color:#111 !important; }
      .tag, .pill{ color:#111 !important; border-color:#ddd !important; }
      .bar{ border-color:#ddd !important; background:#f2f2f2 !important; }
      .bar > div{ background:#bbb !important; }
      @page{ size:A4; margin: 12mm; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Meltdown Trigger Tracker</h1>
      <p class="sub">
        Private, local-only tracker to spot patterns without judgement. No accounts, no syncing, no backend —
        data stays on <b>this device</b>.
      </p>
      <div class="pill" id="countPill">0 entries</div>
    </div>
    <div class="row noPrint">
      <button id="printBtn" class="primary" type="button">Print</button>
      <button id="exportBtn" type="button">Copy CSV</button>
      <button id="clearBtn" class="danger" type="button">Clear all</button>
    </div>
  </header>

  <main class="wrap">
    <!-- LEFT: FORM + EXPERIMENTS -->
    <section class="panel">
      <div class="panelHead">
        <h2 style="margin:0 0 6px;font-size:16px;">Log an incident</h2>
        <div class="small">Keep it quick. You’re looking for patterns, not perfect notes.</div>
      </div>
      <div class="panelBody">
        <form id="entryForm" autocomplete="off">
          <input type="hidden" id="editId" value="" />
          <div class="grid">
            <div class="field">
              <label for="dateInput">Date</label>
              <input id="dateInput" type="date" required />
            </div>
            <div class="field">
              <label for="timeInput">Time</label>
              <input id="timeInput" type="time" required />
            </div>

            <div class="field full">
              <label for="contextInput">What was happening? (context)</label>
              <input id="contextInput" type="text" maxlength="90" placeholder="e.g., leaving house, homework, supermarket" required />
            </div>

            <div class="field">
              <label for="intensityInput">Intensity (1–5)</label>
              <select id="intensityInput">
                <option value="1">1 (mild)</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5 (very intense)</option>
              </select>
            </div>

            <div class="field">
              <label for="durationInput">Duration (mins)</label>
              <select id="durationInput">
                <option value="">Unknown</option>
                <option value="2">0–5</option>
                <option value="7">5–10</option>
                <option value="15">10–20</option>
                <option value="30">20–40</option>
                <option value="60">40–60</option>
                <option value="90">60+</option>
              </select>
            </div>

            <div class="field full">
              <label>Sensory / situation tags (tap to select)</label>
              <div class="chips" id="tagChips" aria-label="Tag selector"></div>
              <div class="small" style="margin-top:6px;">Choose a few. You can add notes below if needed.</div>
            </div>

            <div class="field">
              <label for="hungerInput">Hunger</label>
              <select id="hungerInput">
                <option value="0">Not sure</option>
                <option value="1">Fine</option>
                <option value="2" selected>A bit hungry</option>
                <option value="3">Very hungry</option>
              </select>
            </div>
            <div class="field">
              <label for="tiredInput">Tiredness</label>
              <select id="tiredInput">
                <option value="0">Not sure</option>
                <option value="1">Fine</option>
                <option value="2" selected>A bit tired</option>
                <option value="3">Very tired</option>
              </select>
            </div>

            <div class="field full">
              <label style="margin-bottom:0;">Day type</label>
              <label class="inlineCheck" for="lowDemandInput" style="margin-top:0;">
                <input id="lowDemandInput" type="checkbox" />
                <span><b>Low-demand day</b> (lighter expectations / fewer transitions)</span>
              </label>
              <div class="small">This helps you compare “normal days” vs “we kept it gentle” days.</div>
            </div>

            <div class="field full">
              <label>Active experiments (auto-attached)</label>
              <div id="activeExpPills" class="chips" aria-label="Active experiments list"></div>
              <div class="small" style="margin-top:6px;">Start an experiment below (e.g., “headphones in supermarket”). Any active experiment is saved with this entry.</div>
            </div>

            <div class="field full">
              <label for="notesInput">Notes (optional)</label>
              <textarea id="notesInput" maxlength="240" placeholder="e.g., noise in shop, change of plan, sibling conflict, transition"></textarea>
            </div>
          </div>

          <div class="row" style="justify-content:flex-start;margin-top:12px;">
            <button id="saveBtn" class="primary" type="submit">Add entry</button>
            <button id="cancelBtn" class="ghost" type="button" style="display:none;">Cancel edit</button>
          </div>

          <div class="status" id="status" aria-live="polite"></div>
        </form>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0;" />

        <div>
          <div class="expRow">
            <div>
              <div style="font-weight:800;">“What changed?” experiments</div>
              <div class="small">Run one small change for a week: headphones, snack before outing, visual countdown, etc.</div>
            </div>
          </div>

          <div class="grid" style="margin-top:10px;">
            <div class="field full">
              <label for="expName">Experiment name</label>
              <input id="expName" type="text" maxlength="80" placeholder="e.g., Headphones in supermarket" />
            </div>
            <div class="field full">
              <label for="expNote">Experiment notes (optional)</label>
              <input id="expNote" type="text" maxlength="120" placeholder="e.g., Put on before entering. Let child choose playlist." />
            </div>
            <div class="field">
              <label for="expStart">Start date</label>
              <input id="expStart" type="date" />
            </div>
            <div class="field" style="display:flex;justify-content:flex-end;gap:10px;">
              <label style="opacity:0;">.</label>
              <button id="addExpBtn" class="ok" type="button">Start experiment</button>
            </div>
          </div>

          <div class="expList" id="expList"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: SUMMARY + CHARTS + TABLE -->
    <section class="panel">
      <div class="panelHead">
        <h2 style="margin:0 0 6px;font-size:16px;">Patterns, charts & recent entries</h2>
        <div class="small">This is simple trend-spotting — not diagnosis. Use it to test small changes.</div>
      </div>

      <div class="summary">
        <div class="card">
          <h3>Last 7 days</h3>
          <div class="big" id="last7">0</div>
          <div class="small">entries</div>
        </div>
        <div class="card">
          <h3>Last 30 days</h3>
          <div class="big" id="last30">0</div>
          <div class="small">entries</div>
        </div>

        <div class="card">
          <h3>Avg intensity (30 days)</h3>
          <div class="big" id="avg30">0.0</div>
          <div class="small">out of 5</div>
        </div>
        <div class="card">
          <h3>Low-demand days (30 days)</h3>
          <div class="big" id="low30">0</div>
          <div class="small">entries logged</div>
        </div>

        <div class="card" style="grid-column:1 / -1;">
          <h3>Intensity distribution (30 days)</h3>
          <div class="list" id="intensityDist"></div>
        </div>

        <div class="card" style="grid-column:1 / -1;">
          <h3>Top tags (30 days)</h3>
          <div class="list" id="topTags"></div>
          <div class="small" style="margin-top:8px;">Tip: if one tag dominates, try changing just <b>one</b> thing linked to it for a week.</div>
        </div>

        <div class="card" style="grid-column:1 / -1;">
          <h3>Average intensity by tag (30 days)</h3>
          <div class="list" id="avgByTag"></div>
          <div class="small" style="margin-top:8px;">This helps separate “common” triggers from “high-impact” triggers.</div>
        </div>

        <div class="card" style="grid-column:1 / -1;">
          <h3>Time of day (30 days)</h3>
          <div class="list" id="timeOfDay"></div>
          <div class="small" style="margin-top:8px;">Rough view (morning / afternoon / evening / night).</div>
        </div>

        <div class="card" style="grid-column:1 / -1;">
          <h3>Low-demand vs normal days (30 days)</h3>
          <div class="list" id="lowVsNormal"></div>
          <div class="small" style="margin-top:8px;">Use this as a prompt: what did you do differently on low-demand days?</div>
        </div>
      </div>

      <div class="tableWrap">
        <table aria-label="Entries table">
          <thead>
            <tr>
              <th style="width:120px;">When</th>
              <th>Context</th>
              <th style="width:90px;">Int.</th>
              <th style="width:140px;">Tags / Experiments</th>
              <th style="width:130px;" class="noPrint">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    (function(){
      "use strict";

      // ---- Storage (supports old format too) ----
      const STORAGE_KEY = "meltdown_trigger_tracker_v2";

      const TAGS = [
        "Noise", "Crowds", "Bright lights", "Transition", "Change of plan",
        "Waiting", "Demand placed", "Homework", "Leaving house", "Returning home",
        "Hunger", "Tired", "Pain / illness", "Clothing / texture", "Temperature",
        "Sibling conflict", "Social pressure", "Screen stopped", "Unexpected touch",
        "Toilet / hygiene", "New place", "Too many choices"
      ];

      /** @type {Array<{
        id:string,
        ts:number,
        date:string,
        time:string,
        context:string,
        intensity:number,
        duration:number|null,
        tags:string[],
        hunger:number,
        tired:number,
        lowDemand:boolean,
        experiments:string[], // experiment ids active at time of logging
        notes:string
      }>} */
      let entries = [];

      /** @type {Array<{
        id:string,
        name:string,
        note:string,
        startDate:string,
        endDate:string|null, // null means active
        createdTs:number
      }>} */
      let experiments = [];

      // DOM helpers
      const $ = (s) => document.querySelector(s);

      // Form
      const form = $("#entryForm");
      const editId = $("#editId");
      const dateInput = $("#dateInput");
      const timeInput = $("#timeInput");
      const contextInput = $("#contextInput");
      const intensityInput = $("#intensityInput");
      const durationInput = $("#durationInput");
      const hungerInput = $("#hungerInput");
      const tiredInput = $("#tiredInput");
      const lowDemandInput = $("#lowDemandInput");
      const notesInput = $("#notesInput");
      const saveBtn = $("#saveBtn");
      const cancelBtn = $("#cancelBtn");
      const status = $("#status");
      const tagChips = $("#tagChips");
      const activeExpPills = $("#activeExpPills");

      // Experiments UI
      const expName = $("#expName");
      const expNote = $("#expNote");
      const expStart = $("#expStart");
      const addExpBtn = $("#addExpBtn");
      const expList = $("#expList");

      // Summary / charts
      const tbody = $("#tbody");
      const last7 = $("#last7");
      const last30 = $("#last30");
      const avg30 = $("#avg30");
      const low30 = $("#low30");
      const intensityDist = $("#intensityDist");
      const topTags = $("#topTags");
      const avgByTag = $("#avgByTag");
      const timeOfDay = $("#timeOfDay");
      const lowVsNormal = $("#lowVsNormal");
      const countPill = $("#countPill");

      // Header buttons
      const printBtn = $("#printBtn");
      const exportBtn = $("#exportBtn");
      const clearBtn = $("#clearBtn");

      // chip selection
      const selectedTags = new Set();

      function uid(){
        return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function announce(msg){
        status.textContent = msg;
        window.clearTimeout(announce._t);
        announce._t = window.setTimeout(() => status.textContent = "", 2200);
      }

      function save(){
        const payload = { entries, experiments };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        announce("Saved on this device.");
      }

      function load(){
        // v2
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const parsed = JSON.parse(raw);
            if(parsed && typeof parsed === "object"){
              if(Array.isArray(parsed.entries)) entries = parsed.entries;
              if(Array.isArray(parsed.experiments)) experiments = parsed.experiments;
              return;
            }
          }
        }catch(e){ /* ignore */ }

        // v1 fallback (if user pasted your previous version)
        try{
          const rawOld = localStorage.getItem("meltdown_trigger_tracker_v1");
          if(rawOld){
            const arr = JSON.parse(rawOld);
            if(Array.isArray(arr)){
              entries = arr.map(e => ({
                id: e.id || uid(),
                ts: e.ts || Date.now(),
                date: e.date || todayISO(),
                time: e.time || nowTime(),
                context: e.context || "",
                intensity: Number(e.intensity || 3),
                duration: e.duration ?? null,
                tags: Array.isArray(e.tags) ? e.tags : [],
                hunger: Number(e.hunger || 0),
                tired: Number(e.tired || 0),
                lowDemand: false,
                experiments: [],
                notes: e.notes || ""
              }));
              experiments = [];
              // migrate into v2 key
              save();
            }
          }
        }catch(e){ /* ignore */ }
      }

      function todayISO(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }

      function nowTime(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function parseDateTime(dateStr, timeStr){
        const [y,m,dd] = dateStr.split("-").map(Number);
        const [hh,mm] = timeStr.split(":").map(Number);
        const d = new Date();
        d.setFullYear(y, (m-1), dd);
        d.setHours(hh||0, mm||0, 0, 0);
        return d.getTime();
      }

      function withinDays(ts, days){
        const now = Date.now();
        const cutoff = now - days*24*60*60*1000;
        return ts >= cutoff;
      }

      function timeBucket(timeStr){
        const hh = Number(timeStr.split(":")[0] || 0);
        if(hh >= 5 && hh < 12) return "Morning (5–11)";
        if(hh >= 12 && hh < 17) return "Afternoon (12–16)";
        if(hh >= 17 && hh < 22) return "Evening (17–21)";
        return "Night (22–4)";
      }

      function labelLevel(v){
        const n = Number(v);
        if(n === 1) return "Fine";
        if(n === 2) return "A bit";
        if(n === 3) return "Very";
        return "Not sure";
      }

      // --------- Tags UI ----------
      function renderChips(){
        const frag = document.createDocumentFragment();
        TAGS.forEach(tag=>{
          const b = document.createElement("button");
          b.type = "button";
          b.className = "chip";
          b.textContent = tag;
          b.setAttribute("aria-pressed", "false");
          b.addEventListener("click", ()=>{
            if(selectedTags.has(tag)) selectedTags.delete(tag);
            else selectedTags.add(tag);
            b.setAttribute("aria-pressed", selectedTags.has(tag) ? "true" : "false");
          });
          frag.appendChild(b);
        });
        tagChips.appendChild(frag);
      }

      function setChipSelection(tags){
        selectedTags.clear();
        const buttons = tagChips.querySelectorAll(".chip");
        buttons.forEach(btn=>{
          const tag = btn.textContent;
          const on = tags.includes(tag);
          if(on) selectedTags.add(tag);
          btn.setAttribute("aria-pressed", on ? "true" : "false");
        });
      }

      // --------- Experiments ----------
      function activeExperiments(){
        return experiments.filter(x => x.endDate === null);
      }

      function experimentsActiveOn(ts){
        // entries already store experiment ids at logging time; this is used for experiment stats (date window)
        // but also allow window-based comparison:
        return experiments.filter(exp=>{
          const startTs = parseDateTime(exp.startDate, "00:00");
          const endTs = exp.endDate ? parseDateTime(exp.endDate, "23:59") : Date.now();
          return ts >= startTs && ts <= endTs;
        });
      }

      function renderActiveExperimentPills(){
        activeExpPills.innerHTML = "";
        const act = activeExperiments();
        if(act.length === 0){
          const d = document.createElement("div");
          d.className = "small";
          d.textContent = "No active experiments.";
          activeExpPills.appendChild(d);
          return;
        }
        act.forEach(exp=>{
          const span = document.createElement("div");
          span.className = "chip";
          span.setAttribute("aria-pressed","true");
          span.style.cursor = "default";
          span.textContent = exp.name;
          activeExpPills.appendChild(span);
        });
      }

      function computeExperimentStats(exp){
        const startTs = parseDateTime(exp.startDate, "00:00");
        const endTs = exp.endDate ? parseDateTime(exp.endDate, "23:59") : Date.now();

        const inWindow = entries.filter(e => e.ts >= startTs && e.ts <= endTs);
        const count = inWindow.length;
        const avgInt = count ? (inWindow.reduce((s,e)=> s + (e.intensity||0), 0) / count) : 0;
        const lowCount = inWindow.filter(e => e.lowDemand).length;

        // A simple "before" comparison: same window length immediately before start
        const windowLen = endTs - startTs;
        const beforeStart = startTs - windowLen;
        const beforeEnd = startTs;
        const before = entries.filter(e => e.ts >= beforeStart && e.ts < beforeEnd);
        const bCount = before.length;
        const bAvgInt = bCount ? (before.reduce((s,e)=> s + (e.intensity||0), 0) / bCount) : 0;

        return {
          count, avgInt, lowCount,
          beforeCount: bCount,
          beforeAvgInt: bAvgInt
        };
      }

      function renderExperiments(){
        expList.innerHTML = "";
        const sorted = [...experiments].sort((a,b)=> (b.createdTs||0) - (a.createdTs||0));

        if(sorted.length === 0){
          const div = document.createElement("div");
          div.className = "small";
          div.textContent = "No experiments yet. Start one small change above.";
          expList.appendChild(div);
          return;
        }

        sorted.forEach(exp=>{
          const item = document.createElement("div");
          item.className = "expItem";

          const isActive = exp.endDate === null;
          const stats = computeExperimentStats(exp);

          item.innerHTML = `
            <div class="expTop">
              <div>
                <div class="expName">${escapeHtml(exp.name)}</div>
                <div class="expMeta">
                  ${escapeHtml(exp.startDate)} → ${exp.endDate ? escapeHtml(exp.endDate) : "<b>Active</b>"}
                  ${exp.note ? ` · ${escapeHtml(exp.note)}` : ""}
                </div>
              </div>
              <div class="expBtns noPrint">
                ${isActive
                  ? `<button type="button" class="ok" data-stop="${exp.id}">Stop</button>`
                  : `<button type="button" class="ghost" data-restart="${exp.id}">Restart</button>`
                }
                <button type="button" class="danger" data-expdel="${exp.id}">Delete</button>
              </div>
            </div>

            <div class="expStats">
              <span class="pill">During: ${stats.count} entries</span>
              <span class="pill">Avg int: ${stats.avgInt.toFixed(1)}/5</span>
              <span class="pill">Low-demand: ${stats.lowCount}</span>
              <span class="pill">Before: ${stats.beforeCount} entries</span>
              <span class="pill">Before avg: ${stats.beforeAvgInt.toFixed(1)}/5</span>
            </div>
          `;

          expList.appendChild(item);
        });

        // wire buttons
        expList.querySelectorAll("button[data-stop]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const id = b.dataset.stop;
            const exp = experiments.find(x => x.id === id);
            if(!exp) return;
            exp.endDate = todayISO();
            save();
            render();
            announce("Experiment stopped.");
          });
        });

        expList.querySelectorAll("button[data-restart]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const id = b.dataset.restart;
            const exp = experiments.find(x => x.id === id);
            if(!exp) return;
            // restart as a new experiment to keep windows clean
            const newExp = {
              id: uid(),
              name: exp.name,
              note: exp.note || "",
              startDate: todayISO(),
              endDate: null,
              createdTs: Date.now()
            };
            experiments.unshift(newExp);
            save();
            render();
            announce("Experiment restarted.");
          });
        });

        expList.querySelectorAll("button[data-expdel]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const id = b.dataset.expdel;
            const ok = confirm("Delete this experiment? (Entries remain, but won’t reference it as ‘active’.)");
            if(!ok) return;
            experiments = experiments.filter(x => x.id !== id);
            // remove refs from entries
            entries = entries.map(e => ({...e, experiments: (e.experiments||[]).filter(x => x !== id)}));
            save();
            render();
            announce("Experiment deleted.");
          });
        });
      }

      // --------- Charts ----------
      function barRow(label, value, max, rightText){
        const pct = max > 0 ? Math.round((value/max)*100) : 0;
        const div = document.createElement("div");
        div.className = "barRow";
        div.innerHTML = `
          <div>
            <div style="font-weight:700;">${escapeHtml(label)}</div>
            <div class="bar" aria-hidden="true"><div style="width:${pct}%"></div></div>
          </div>
          <div class="pill">${escapeHtml(rightText)}</div>
        `;
        return div;
      }

      function renderSummaryAndCharts(){
        const e30 = entries.filter(e => withinDays(e.ts, 30));
        const e7 = entries.filter(e => withinDays(e.ts, 7));

        last7.textContent = String(e7.length);
        last30.textContent = String(e30.length);
        countPill.textContent = `${entries.length} entr${entries.length===1?"y":"ies"}`;

        // avg intensity 30
        const avg = e30.length ? (e30.reduce((s,e)=> s + (e.intensity||0), 0) / e30.length) : 0;
        avg30.textContent = avg.toFixed(1);

        // low-demand count 30
        const lowCnt = e30.filter(e => e.lowDemand).length;
        low30.textContent = String(lowCnt);

        // intensity distribution 30
        const dist = [0,0,0,0,0,0]; // 1..5
        e30.forEach(e=>{
          const i = Math.min(5, Math.max(1, Number(e.intensity||3)));
          dist[i] += 1;
        });
        intensityDist.innerHTML = "";
        const maxD = Math.max(...dist.slice(1));
        for(let i=1;i<=5;i++){
          intensityDist.appendChild(barRow(`Intensity ${i}`, dist[i], maxD, String(dist[i])));
        }
        if(e30.length === 0){
          intensityDist.innerHTML = `<div class="small">No entries in the last 30 days.</div>`;
        }

        // Top tags 30
        const tagCounts = new Map();
        e30.forEach(e => (e.tags||[]).forEach(t => tagCounts.set(t, (tagCounts.get(t)||0)+1)));
        const top = [...tagCounts.entries()].sort((a,b)=> b[1]-a[1]).slice(0,7);
        topTags.innerHTML = "";
        if(top.length === 0){
          topTags.innerHTML = `<div class="small">No tags yet. Log a few entries and pick 2–4 tags each time.</div>`;
        }else{
          const max = top[0][1];
          top.forEach(([t,c]) => topTags.appendChild(barRow(t, c, max, String(c))));
        }

        // Avg intensity by tag 30
        const tagAgg = new Map(); // tag -> {sum,count}
        e30.forEach(e=>{
          const i = Number(e.intensity||0);
          (e.tags||[]).forEach(t=>{
            const cur = tagAgg.get(t) || {sum:0,count:0};
            cur.sum += i;
            cur.count += 1;
            tagAgg.set(t, cur);
          });
        });
        const avgTags = [...tagAgg.entries()]
          .map(([t,obj]) => [t, obj.count ? obj.sum/obj.count : 0, obj.count])
          .sort((a,b)=> b[1]-a[1])
          .slice(0,7);

        avgByTag.innerHTML = "";
        if(avgTags.length === 0){
          avgByTag.innerHTML = `<div class="small">No tag data yet.</div>`;
        }else{
          const maxAvg = Math.max(...avgTags.map(x=>x[1]));
          avgTags.forEach(([t,a,count])=>{
            avgByTag.appendChild(barRow(`${t}`, a, maxAvg, `${a.toFixed(1)}/5 · ${count}`));
          });
        }

        // Time of day 30
        const buckets = new Map();
        e30.forEach(e=>{
          const b = timeBucket(e.time);
          buckets.set(b, (buckets.get(b)||0)+1);
        });
        const order = ["Morning (5–11)","Afternoon (12–16)","Evening (17–21)","Night (22–4)"];
        const bucketPairs = order.map(k => [k, buckets.get(k)||0]).filter(([k,v])=> v>0);
        timeOfDay.innerHTML = "";
        if(bucketPairs.length === 0){
          timeOfDay.innerHTML = `<div class="small">No entries in the last 30 days.</div>`;
        }else{
          const maxB = Math.max(...bucketPairs.map(x=>x[1]));
          bucketPairs.forEach(([k,v]) => timeOfDay.appendChild(barRow(k, v, maxB, String(v))));
        }

        // Low-demand vs normal (30)
        const lowEntries = e30.filter(e=> e.lowDemand);
        const normEntries = e30.filter(e=> !e.lowDemand);
        const lowAvg = lowEntries.length ? lowEntries.reduce((s,e)=> s + (e.intensity||0),0)/lowEntries.length : 0;
        const normAvg = normEntries.length ? normEntries.reduce((s,e)=> s + (e.intensity||0),0)/normEntries.length : 0;

        lowVsNormal.innerHTML = "";
        if(e30.length === 0){
          lowVsNormal.innerHTML = `<div class="small">No entries in the last 30 days.</div>`;
        }else{
          const maxA = Math.max(lowAvg, normAvg) || 1;
          lowVsNormal.appendChild(barRow(`Low-demand days`, lowAvg, maxA, `${lowEntries.length} · ${lowAvg.toFixed(1)}/5`));
          lowVsNormal.appendChild(barRow(`Normal days`, normAvg, maxA, `${normEntries.length} · ${normAvg.toFixed(1)}/5`));
        }
      }

      // --------- Table ----------
      function renderTable(){
        const sorted = [...entries].sort((a,b)=> b.ts - a.ts).slice(0, 70);
        tbody.innerHTML = "";

        if(sorted.length === 0){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.innerHTML = `<div class="small" style="padding:10px;">No entries yet. Add one on the left.</div>`;
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const expMap = new Map(experiments.map(x => [x.id, x]));

        sorted.forEach(e=>{
          const tr = document.createElement("tr");
          const when = `${escapeHtml(e.date)}<br><span class="small">${escapeHtml(e.time)}</span>`;

          const tagHtml = (e.tags || []).slice(0,5).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");
          const expHtml = (e.experiments || [])
            .map(id => expMap.get(id))
            .filter(Boolean)
            .slice(0,3)
            .map(exp => `<span class="tag">${escapeHtml(exp.name)}</span>`)
            .join("");

          const flags = [];
          if(e.lowDemand) flags.push(`<span class="tag">Low-demand</span>`);
          const flagsHtml = flags.join("");

          const context = `
            <div style="font-weight:700;">${escapeHtml(e.context)}</div>
            ${e.notes ? `<div class="small" style="margin-top:6px;">${escapeHtml(e.notes)}</div>` : ``}
            <div class="small" style="margin-top:6px;">
              Hunger: ${escapeHtml(labelLevel(e.hunger))} · Tired: ${escapeHtml(labelLevel(e.tired))} · ${e.duration ? `Duration: ~${e.duration}m` : `Duration: ?`}
            </div>
          `;

          tr.innerHTML = `
            <td>${when}</td>
            <td>${context}</td>
            <td><span class="pill">${escapeHtml(String(e.intensity))}/5</span></td>
            <td>${tagHtml || `<span class="small">—</span>`}${expHtml ? `<div style="margin-top:6px;">${expHtml}</div>` : ``}${flagsHtml ? `<div style="margin-top:6px;">${flagsHtml}</div>` : ``}</td>
            <td class="noPrint">
              <div class="actions">
                <button type="button" class="ghost" data-edit="${e.id}">Edit</button>
                <button type="button" class="danger" data-del="${e.id}">Delete</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button[data-edit]").forEach(b=>{
          b.addEventListener("click", ()=> startEdit(b.dataset.edit));
        });
        tbody.querySelectorAll("button[data-del]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const ok = confirm("Delete this entry?");
            if(ok) deleteEntry(b.dataset.del);
          });
        });
      }

      function render(){
        renderActiveExperimentPills();
        renderExperiments();
        renderSummaryAndCharts();
        renderTable();
      }

      // --------- Form helpers ----------
      function clearForm(){
        editId.value = "";
        dateInput.value = todayISO();
        timeInput.value = nowTime();
        contextInput.value = "";
        intensityInput.value = "3";
        durationInput.value = "";
        hungerInput.value = "2";
        tiredInput.value = "2";
        lowDemandInput.checked = false;
        notesInput.value = "";
        setChipSelection([]);
        saveBtn.textContent = "Add entry";
        cancelBtn.style.display = "none";
        contextInput.focus();
      }

      function startEdit(id){
        const e = entries.find(x => x.id === id);
        if(!e) return;
        editId.value = e.id;
        dateInput.value = e.date;
        timeInput.value = e.time;
        contextInput.value = e.context;
        intensityInput.value = String(e.intensity);
        durationInput.value = e.duration ? String(e.duration) : "";
        hungerInput.value = String(e.hunger);
        tiredInput.value = String(e.tired);
        lowDemandInput.checked = !!e.lowDemand;
        notesInput.value = e.notes || "";
        setChipSelection(e.tags || []);
        saveBtn.textContent = "Save changes";
        cancelBtn.style.display = "inline-flex";
        announce("Editing entry…");
      }

      function deleteEntry(id){
        const idx = entries.findIndex(x => x.id === id);
        if(idx === -1) return;
        entries.splice(idx, 1);
        save();
        render();
        announce("Deleted entry.");
      }

      // --------- Wire events ----------
      form.addEventListener("submit", (ev)=>{
        ev.preventDefault();

        const date = dateInput.value;
        const time = timeInput.value;
        const context = (contextInput.value || "").trim();

        if(!date || !time || !context){
          announce("Date, time and context are required.");
          return;
        }

        const intensity = Number(intensityInput.value || 3);
        const duration = durationInput.value ? Number(durationInput.value) : null;
        const hunger = Number(hungerInput.value || 0);
        const tired = Number(tiredInput.value || 0);
        const lowDemand = !!lowDemandInput.checked;

        const tags = [...selectedTags];
        const notes = (notesInput.value || "").trim();
        const ts = parseDateTime(date, time);

        // attach active experiments (ids)
        const activeExpIds = activeExperiments().map(x => x.id);

        const editing = (editId.value || "").trim();
        if(editing){
          const idx = entries.findIndex(x => x.id === editing);
          if(idx !== -1){
            // keep experiments from the original entry if user was editing an older event,
            // BUT also allow "active now" to attach if they want—this is usually not desired.
            // So we keep the original list unless user confirms.
            const keepOld = confirm("Editing an entry: keep its original experiment links?\n\nOK = keep original\nCancel = replace with currently active experiments");
            const experimentsForEntry = keepOld ? (entries[idx].experiments || []) : activeExpIds;

            entries[idx] = { ...entries[idx], ts, date, time, context, intensity, duration, tags, hunger, tired, lowDemand, experiments: experimentsForEntry, notes };
            announce("Updated entry.");
          }
        }else{
          entries.push({ id: uid(), ts, date, time, context, intensity, duration, tags, hunger, tired, lowDemand, experiments: activeExpIds, notes });
          announce("Added entry.");
        }

        save();
        render();
        clearForm();
      });

      cancelBtn.addEventListener("click", ()=>{
        clearForm();
        announce("Edit cancelled.");
      });

      printBtn.addEventListener("click", ()=> window.print());

      exportBtn.addEventListener("click", async ()=>{
        const expMap = new Map(experiments.map(x=>[x.id,x]));
        const header = ["date","time","context","intensity","duration_mins","hunger","tired","low_demand","tags","experiments","notes"];
        const rows = entries
          .sort((a,b)=> a.ts - b.ts)
          .map(e => [
            e.date,
            e.time,
            e.context,
            e.intensity,
            e.duration ?? "",
            e.hunger,
            e.tired,
            e.lowDemand ? "yes" : "no",
            (e.tags||[]).join("|"),
            (e.experiments||[]).map(id => expMap.get(id)?.name).filter(Boolean).join("|"),
            (e.notes||"").replaceAll("\n"," ")
          ]);

        const csv = [header, ...rows]
          .map(cols => cols.map(c => `"${String(c).replaceAll('"','""')}"`).join(","))
          .join("\n");

        try{
          await navigator.clipboard.writeText(csv);
          announce("Copied CSV to clipboard.");
        }catch{
          const ta = document.createElement("textarea");
          ta.value = csv;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          announce("Copied CSV to clipboard.");
        }
      });

      clearBtn.addEventListener("click", ()=>{
        if(entries.length === 0 && experiments.length === 0) return;
        const ok = confirm("Clear ALL entries + experiments? This cannot be undone.");
        if(!ok) return;
        entries = [];
        experiments = [];
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem("meltdown_trigger_tracker_v1");
        render();
        clearForm();
        announce("Cleared.");
      });

      // Experiments: add/start
      addExpBtn.addEventListener("click", ()=>{
        const name = (expName.value || "").trim();
        if(!name){
          announce("Experiment name is required.");
          expName.focus();
          return;
        }
        const startDate = expStart.value || todayISO();
        const note = (expNote.value || "").trim();

        const newExp = {
          id: uid(),
          name,
          note,
          startDate,
          endDate: null,
          createdTs: Date.now()
        };
        experiments.unshift(newExp);

        expName.value = "";
        expNote.value = "";
        expStart.value = todayISO();

        save();
        render();
        announce("Experiment started.");
      });

      // --------- Init ----------
      renderChips();
      load();
      dateInput.value = todayISO();
      timeInput.value = nowTime();
      expStart.value = todayISO();
      render();
      clearForm();
    })();
  </script>
</body>
</html>